name: Build Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout代码
      uses: actions/checkout@v4
      with:
        clean: true
    
    - name: 验证buildozer.spec编码
      run: |
        echo "检查buildozer.spec文件..."
        xxd -l 20 buildozer.spec
        python3 -c "import configparser; c = configparser.ConfigParser(); c.read('buildozer.spec'); print('✓ buildozer.spec OK')"
    
    - name: 设置Python环境
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: 安装系统依赖
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git zip unzip openjdk-17-jdk \
          python3-pip autoconf libtool pkg-config \
          zlib1g-dev libncurses5-dev libncursesw5-dev \
          libtinfo5 cmake libffi-dev libssl-dev \
          build-essential ccache m4 automake libltdl-dev
    
    - name: 设置Java环境
      run: |
        echo "JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64" >> $GITHUB_ENV
        echo "PATH=$JAVA_HOME/bin:$PATH" >> $GITHUB_ENV
    
    - name: 安装Buildozer
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install buildozer==1.5.0 cython==0.29.33 virtualenv sh
    
    - name: 构建APK
      run: |
        export BUILDOZER_LOG_LEVEL=2
        buildozer -v android debug 2>&1 | tee build.log
      id: build_step
    
    - name: 上传构建日志
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log-${{ github.run_number }}
        path: build.log
        retention-days: 7
    
    - name: 查找并复制APK
      if: success()
      run: |
        echo "=== 搜索APK文件 ==="
        find .buildozer -name "*.apk" -type f
        echo ""
        echo "=== 复制APK到bin目录 ==="
        mkdir -p bin
        find .buildozer -name "*.apk" -type f -exec cp -v {} bin/ \;
        echo ""
        echo "=== bin目录内容 ==="
        ls -lh bin/ || echo "bin目录为空"
        echo ""
        echo "=== 验证APK文件 ==="
        APK_COUNT=$(ls -1 bin/*.apk 2>/dev/null | wc -l)
        if [ "$APK_COUNT" -gt 0 ]; then
          echo "✓ 找到 $APK_COUNT 个APK文件"
        else
          echo "✗ 未找到APK文件"
          exit 1
        fi
    
    - name: 上传APK
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: binance-analyzer-apk
        path: bin/*.apk
        retention-days: 90
    
    - name: 创建Release
      if: success() && github.ref == 'refs/heads/master'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v1.0.${{ github.run_number }}
        name: 币安分析工具 v1.0.${{ github.run_number }}
        body: |
          ## 🎉 币安合约分析工具 Android版
          
          ### 📥 下载安装
          1. 下载下方的APK文件
          2. 传输到Android手机
          3. 允许"未知来源"安装
          4. 授予必要权限（网络、存储、通知等）
          
          ### ✨ 功能特性
          - ✅ 实时分析币安合约三日涨幅
          - ✅ 后台定时自动运行（1-24小时可配置）
          - ✅ 智能通知推送（结果变化时提醒）
          - ✅ 历史记录查看和对比
          - ✅ 参数自定义配置
          - ✅ Material Design界面
          
          ### ⚙️ 配置参数
          - 最小涨幅：默认100%（可调整）
          - 流动性阈值：1,000,000 USDT
          - 最大分析数量：500个币种
          
          ### 📱 系统要求
          - Android 5.0+ (API 21+)
          - 网络连接
          - 约50MB存储空间
          
          ### 📖 使用说明
          详见项目README.md
          
          ---
          构建时间: ${{ github.event.head_commit.timestamp }}
          提交: ${{ github.sha }}
        files: bin/*.apk
        draft: false
        prerelease: false
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}