name: Build Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout代码
      uses: actions/checkout@v4
    
    - name: 设置Python环境
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: 安装系统依赖
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git zip unzip openjdk-17-jdk \
          python3-pip autoconf libtool pkg-config \
          zlib1g-dev libncurses5-dev libncursesw5-dev \
          libtinfo5 cmake libffi-dev libssl-dev \
          build-essential ccache m4 libtool \
          libffi-dev libssl-dev automake
    
    - name: 设置Java环境变量
      run: |
        echo "JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64" >> $GITHUB_ENV
        echo "PATH=$JAVA_HOME/bin:$PATH" >> $GITHUB_ENV
    
    - name: 安装Python依赖
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install buildozer==1.5.0
        pip install cython==0.29.33
        pip install virtualenv
    
    - name: 缓存Buildozer目录
      uses: actions/cache@v4
      with:
        path: |
          .buildozer
          ~/.buildozer
        key: ${{ runner.os }}-buildozer-${{ hashFiles('buildozer.spec') }}
        restore-keys: |
          ${{ runner.os }}-buildozer-
    
    - name: 构建APK
      run: |
        # 确保buildozer.spec存在
        if [ ! -f buildozer.spec ]; then
          echo "错误: buildozer.spec 文件不存在"
          exit 1
        fi
        
        # 显示Python和Buildozer版本
        python --version
        buildozer --version
        
        # 构建
        buildozer -v android debug
      continue-on-error: false
    
    - name: 检查APK文件
      run: |
        if [ -d "bin" ]; then
          echo "bin目录内容:"
          ls -lh bin/
        else
          echo "错误: bin目录不存在"
          exit 1
        fi
    
    - name: 上传APK
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: binance-analyzer-apk-${{ github.run_number }}
        path: bin/*.apk
        retention-days: 30
    
    - name: 上传构建日志
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ github.run_number }}
        path: |
          .buildozer/android/platform/build-*/build.log
          .buildozer/android/platform/build-*/logs/*
        retention-days: 7
        if-no-files-found: ignore
    
    - name: 创建Release
      if: success() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v1.0.${{ github.run_number }}
        name: Release v1.0.${{ github.run_number }}
        body: |
          ## 币安合约分析工具 v1.0.${{ github.run_number }}
          
          ### 功能特性
          - ✅ 实时分析币安合约
          - ✅ 定时后台运行
          - ✅ 智能通知推送
          - ✅ 历史记录查看
          - ✅ 参数自定义配置
          
          ### 安装说明
          1. 下载下方的APK文件
          2. 传输到Android手机
          3. 允许"未知来源"安装
          4. 授予必要权限
          
          ### 系统要求
          - Android 5.0+ (API 21+)
          - 网络连接
        files: bin/*.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
