# 24小时不间断运行完全指南

## 🎯 目标
实现应用在后台24小时不间断运行，即使息屏、锁屏、清理后台都不会被杀死。

---

## ✅ 已实现的保活机制

### 1. 前台服务（最核心）
```
优先级: IMPORTANCE_DEFAULT
通知ID: 999
特性: 持久通知、不可删除、点击可打开应用
效果: 系统优先级提升，不会被轻易杀死
```

### 2. WakeLock（防止CPU休眠）
```
类型: PARTIAL_WAKE_LOCK
作用: 保持CPU运行，屏幕可关闭
效果: 定时任务正常执行
```

### 3. 心跳机制（监控运行状态）
```
间隔: 每5分钟
作用: 检测服务是否存活
日志: 记录运行时间和状态
```

### 4. 异常自动恢复
```
机制: try-catch包裹所有关键代码
效果: 出错后自动重试，不会退出
```

---

## 🔧 必须完成的系统设置

### iQOO/vivo设备（6步必做）

#### 第1步：自启动管理 ⭐⭐⭐
```
路径: i管家 → 应用管理 → 权限管理 → 自启动 → 开启
作用: 允许应用开机自启和被杀后重启
```

#### 第2步：后台高耗电 ⭐⭐⭐
```
路径: i管家 → 省电管理 → 后台高耗电 → 允许
作用: 允许应用在后台使用更多资源
```

#### 第3步：后台耗电管理 ⭐⭐⭐
```
路径: 设置 → 电池 → 后台耗电管理 → 允许后台高耗电
作用: 关闭电池优化限制
```

#### 第4步：后台冻结 ⭐⭐⭐
```
路径: i管家 → 应用管理 → 后台冻结 → 关闭
作用: 防止系统冻结后台应用
```

#### 第5步：锁定后台 ⭐⭐⭐
```
操作: 最近任务 → 下拉应用卡片 → 点击锁定🔒
作用: 清理后台时不会被杀死
```

#### 第6步：关闭省电模式 ⭐⭐
```
路径: 设置 → 电池 → 省电模式 → 关闭
作用: 避免系统限制后台应用
```

---

## 📱 应用内设置

### 1. 开启定时任务
```
应用内 → 定时设置 → 启用定时分析 → 开启
```

### 2. 设置合理的间隔
```
推荐: 2-4小时
原因: 平衡电量消耗和及时性
```

### 3. 开启通知
```
☑ 发现变化时通知
☑ 分析完成后通知
```

---

## 🔍 验证24小时保活

### 测试方法1: 息屏测试
```
1. 开启定时任务（设置为5分钟间隔）
2. 锁屏并等待5分钟
3. 解锁后查看是否收到通知
4. 重复测试3-5次

✅ 通过: 每次都收到通知
❌ 失败: 有时没收到通知 → 检查系统设置
```

### 测试方法2: 长时间测试
```
1. 开启定时任务（设置为2小时间隔）
2. 正常使用手机24小时
3. 检查历史记录，看是否有12次分析记录

✅ 通过: 有10-12次记录（允许1-2次误差）
❌ 失败: 少于8次记录 → 需要优化设置
```

### 测试方法3: 查看进程
```bash
# 连接手机到电脑
adb devices

# 查看应用进程
adb shell ps | grep binance

# 预期输出（应用在运行）:
u0_a123  12345  456  1234567  45678 S org.binance.binanceanalyzer

# 查看WakeLock状态
adb shell dumpsys power | grep BinanceAnalyzer

# 预期输出（WakeLock已获取）:
Wake Locks: PARTIAL_WAKE_LOCK 'BinanceAnalyzer::AppWakeLock'
```

### 测试方法4: 查看通知
```
下拉通知栏 → 应该看到:
🔄 币安分析工具运行中
后台服务已启动 | HH:MM:SS

如果看不到这个通知 → 前台服务未启动 → 检查权限
```

---

## ⚡ 电量优化建议

### 低电量模式（<20%）
```
定时间隔: 6-8小时
最大分析数量: 200
API请求延迟: 0.3秒
预计电量消耗: ~0.5%/小时
```

### 正常模式（20%-80%）
```
定时间隔: 2-4小时
最大分析数量: 500
API请求延迟: 0.15秒
预计电量消耗: ~1-2%/小时
```

### 充电模式（充电中）
```
定时间隔: 1-2小时
最大分析数量: 500
API请求延迟: 0.1秒
预计电量消耗: 无影响（充电中）
```

---

## 🚨 常见问题排查

### 问题1: 息屏后定时任务不执行

**可能原因**:
1. ❌ WakeLock未获取
2. ❌ 前台服务未启动
3. ❌ 系统省电模式限制
4. ❌ 应用被系统冻结

**排查步骤**:
```bash
# 1. 检查WakeLock
adb shell dumpsys power | grep BinanceAnalyzer
# 应该看到: PARTIAL_WAKE_LOCK 'BinanceAnalyzer::AppWakeLock'

# 2. 检查进程
adb shell ps | grep binance
# 应该看到进程ID

# 3. 检查通知
# 下拉通知栏，应该看到前台服务通知

# 4. 查看日志
adb logcat | grep "定时分析"
# 应该看到定时执行的日志
```

**解决方案**:
```
1. 重启应用
2. 检查所有6步系统设置
3. 关闭省电模式
4. 在最近任务中锁定应用
```

---

### 问题2: 清理后台后应用被杀死

**原因**: 未锁定后台

**解决方案**:
```
1. 打开最近任务
2. 找到币安分析工具
3. 下拉应用卡片
4. 点击锁定图标🔒
5. 再次清理后台测试
```

---

### 问题3: 前台服务通知消失

**原因**: 系统清理了通知

**解决方案**:
```
1. 设置 → 通知与状态栏 → 应用通知 → 币安分析工具
2. 允许通知 → 开启
3. 通知渠道 → "24小时后台服务" → 开启
4. 重启应用
```

---

### 问题4: 电量消耗过快

**原因**: 定时间隔太短或分析数量太多

**解决方案**:
```
应用内 → 设置:
1. 定时间隔: 2小时 → 4小时
2. 最大分析数量: 500 → 200
3. API请求延迟: 0.15秒 → 0.2秒
```

---

## 📊 24小时运行数据参考

### 正常运行状态
```
定时间隔: 2小时
分析次数: 12次/天
通知次数: 0-12次（取决于结果）
电量消耗: 2-4%/天
网络流量: 20-50MB/天
```

### 心跳日志示例
```
[心跳] 服务运行中 - 2025-12-19 00:00:00
[心跳] 服务运行中 - 2025-12-19 00:05:00
[心跳] 服务运行中 - 2025-12-19 00:10:00
...
```

### 定时分析日志示例
```
[定时分析] 开始执行... - 2025-12-19 00:00:00
[定时分析] 找到 15 个币种
[定时分析] 执行完成
[定时分析] 开始执行... - 2025-12-19 02:00:00
[定时分析] 找到 12 个币种
[定时分析] 执行完成
...
```

---

## 🎯 最佳实践

### 1. 首次使用
```
1. 安装APK
2. 打开应用，授予所有权限
3. 完成所有6步系统设置
4. 设置定时间隔为5分钟
5. 锁屏测试5分钟
6. 收到通知后，改回2-4小时
7. 锁定后台
8. 正常使用24小时
```

### 2. 日常使用
```
- 不要手动划掉应用
- 保持后台锁定
- 定期查看历史记录
- 充电时可缩短间隔
- 低电量时延长间隔
```

### 3. 故障恢复
```
如果发现应用停止运行:
1. 打开应用（会自动恢复）
2. 检查定时任务是否开启
3. 检查前台服务通知是否显示
4. 重新锁定后台
```

---

## 🔐 安全提示

1. **前台服务通知无法删除** - 这是正常的，保证24小时运行
2. **WakeLock会消耗电量** - 但仅保持CPU运行，影响较小
3. **定期检查运行状态** - 建议每周查看一次历史记录
4. **更新系统后重新设置** - 系统更新可能重置部分设置

---

## 📞 技术支持

### 导出诊断日志
```bash
# 导出完整日志
adb logcat -d > binance_24h.log

# 查看最近1000行
adb logcat -t 1000 | grep -i binance

# 查看服务状态
adb shell dumpsys activity services | grep binance
```

### 报告问题时请提供
1. 手机型号和系统版本
2. 应用版本号
3. 完整的日志文件
4. 已完成的设置截图
5. 问题复现步骤

---

**文档版本**: v1.2.0  
**更新日期**: 2025-12-19  
**适用系统**: Android 5.0+ (重点优化iQOO/vivo)
