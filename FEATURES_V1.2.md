# v1.2.0 新功能详细说明

## 🎯 本次更新概览

本次更新（v1.2.0）主要聚焦于**通知增强**和**后台保活**两大方向，显著提升应用的用户体验和后台稳定性。

---

## 📱 新功能详解

### 1. 通知显示精确时间

#### 功能描述
每条通知在消息内容中显示精确的发送时间（HH:MM:SS格式），同时在Android系统通知栏中显示时间戳。

#### 使用场景
- 查看历史通知时了解具体分析时间
- 判断定时任务是否按时执行
- 追踪市场变化的时间点

#### 效果示例
```
[14:30:25] 找到 15 个符合条件的交易对

【前3名币种】
1. BTCUSDT
   1日: +5.23% | 2日: +8.45% | 3日: +12.67%
```

#### 技术实现
- 使用`datetime.now().strftime("%H:%M:%S")`格式化时间
- 调用`builder.setWhen()`设置通知时间戳
- 调用`builder.setShowWhen(True)`显示时间

---

### 2. 点击通知自动跳转

#### 功能描述
点击通知后，应用自动打开并跳转到"结果"页面，无需手动导航。

#### 使用场景
- 收到通知后快速查看分析结果
- 减少操作步骤，提升用户体验
- 从锁屏状态直达结果页面

#### 交互流程
```
收到通知 → 点击通知 → 应用打开 → 自动跳转到结果页面
```

#### 技术实现
- 使用`PendingIntent`创建点击动作
- 通过`Intent.putExtra()`传递参数`notification_action=open_results`
- 在`App.on_start()`中调用`handle_notification_intent()`处理跳转
- 使用`Clock.schedule_once()`延迟跳转，确保UI完全加载

#### 代码关键点
```python
# 创建Intent并添加参数
intent.putExtra("notification_action", "open_results")

# 处理Intent参数
notification_action = intent.getStringExtra("notification_action")
if notification_action == "open_results":
    self.root.screen_manager.current = "results"
```

---

### 3. WakeLock后台保活

#### 功能描述
使用Android的`PARTIAL_WAKE_LOCK`保持CPU运行，确保应用在后台和锁屏状态下继续执行定时任务。

#### 使用场景
- 应用切换到后台后继续运行
- 锁屏状态下定时分析正常执行
- 屏幕关闭时保持网络连接

#### 电量消耗
- **类型**: `PARTIAL_WAKE_LOCK`（仅保持CPU运行）
- **屏幕**: 可以关闭，不影响功能
- **电量**: 相对较低，建议定时间隔设置为2-4小时

#### WakeLock类型对比
| 类型 | CPU | 屏幕 | 电量消耗 | 推荐 |
|------|-----|------|----------|------|
| PARTIAL_WAKE_LOCK | ✅ | ❌ | 低 | ✅ |
| FULL_WAKE_LOCK | ✅ | ✅ | 高 | ❌ |
| SCREEN_DIM_WAKE_LOCK | ✅ | 🔅 | 中 | ❌ (已废弃) |

#### 生命周期管理
```python
# 应用启动时获取
App.on_start() → acquire_wakelock()

# 应用退出时释放
App.on_stop() → release_wakelock()
```

#### 验证方法
```bash
# 查看WakeLock状态
adb shell dumpsys power | grep BinanceAnalyzer

# 应看到类似输出：
# Wake Locks: size=1
#   PARTIAL_WAKE_LOCK 'BinanceAnalyzer::AppWakeLock' (uid=10123)
```

---

### 4. 锁屏状态保活

#### 功能描述
结合WakeLock和前台服务，确保应用在锁屏状态下继续运行，定时任务不受影响。

#### 使用场景
- 夜间锁屏时继续监控市场
- 长时间离开手机时保持运行
- 充电时后台自动分析

#### 技术保障
1. **WakeLock**: 保持CPU运行
2. **前台服务**: 防止系统杀死进程
3. **持久通知**: 告知用户服务运行中

#### 测试方法
```bash
# 1. 启动应用并开启定时任务
# 2. 锁屏（按电源键）
# 3. 等待定时间隔（如2小时）
# 4. 解锁后检查是否收到通知

# 查看后台日志
adb logcat | grep "定时分析"
```

---

### 5. 前台服务持久通知

#### 功能描述
显示一个持久的低优先级通知，表明后台服务正在运行，防止系统杀死应用进程。

#### 通知内容
```
标题: 币安分析工具
内容: 后台服务运行中...
```

#### 特性
- **优先级**: `IMPORTANCE_LOW`（不打扰用户）
- **持久性**: 不可滑动删除（`setOngoing(True)`）
- **通知ID**: 999（与普通通知分离）
- **点击操作**: 打开应用主界面

#### 隐藏方法
如需隐藏前台服务通知：
1. 关闭定时任务
2. 完全退出应用
3. 重新启动应用

---

### 6. 智能通知逻辑

#### 功能描述
根据匹配结果数量智能决定是否发送通知，避免无意义的通知骚扰。

#### 通知规则

| 当前结果 | 上次结果 | 是否通知 | 通知类型 |
|---------|---------|---------|---------|
| 0 | 0 | ❌ 不通知 | - |
| 0 | >0 | ✅ 通知 | "匹配结果清零" |
| >0 | 0 | ✅ 通知 | 正常通知 |
| >0 | >0 | ✅ 通知 | 正常通知 |

#### 通知示例

**正常通知（有结果）**:
```
标题: 分析完成
内容: [14:30:25] 找到 15 个符合条件的交易对

【前3名币种】
1. BTCUSDT
   1日: +5.23% | 2日: +8.45% | 3日: +12.67%
```

**清零通知（从有变无）**:
```
标题: 匹配结果清零
内容: [16:45:10] 之前有 15 个币种符合条件，现在已全部不符合条件
```

**无通知（持续为0）**:
```
[日志] 匹配数量为 0，跳过通知
```

#### 设计理念
- **减少骚扰**: 持续无结果时不发送通知
- **重要提醒**: 市场从热转冷时及时通知
- **信息完整**: 有结果时显示详细数据

#### 代码逻辑
```python
if current_count == 0:
    if last_count > 0:
        # 从有变无，发送清零通知
        notify_zero_result(last_count)
    else:
        # 持续为0，不通知
        pass
else:
    # 有结果，正常通知
    notify_analysis_complete(current_count, results)
```

---

## 🔧 权限要求

### 新增权限
```ini
WAKE_LOCK                # WakeLock保持唤醒
FOREGROUND_SERVICE       # 前台服务
POST_NOTIFICATIONS       # 通知权限（Android 13+）
SCHEDULE_EXACT_ALARM     # 精确定时
```

### 权限说明
- **WAKE_LOCK**: 允许应用保持CPU运行，防止系统休眠
- **FOREGROUND_SERVICE**: 允许应用运行前台服务，提高优先级
- **POST_NOTIFICATIONS**: Android 13+必须，用于发送通知
- **SCHEDULE_EXACT_ALARM**: 精确定时任务，确保按时执行

### 运行时请求
应用会在首次启动时自动请求这些权限，用户需要手动授予。

---

## 📊 性能影响

### 电量消耗
- **WakeLock**: 低（仅保持CPU）
- **前台服务**: 极低（仅通知）
- **定时任务**: 取决于间隔和分析数量
- **建议**: 定时间隔2-4小时，充电时使用

### 内存占用
- **主应用**: ~50MB
- **后台服务**: ~10MB
- **总计**: ~60MB

### 网络流量
- **单次分析**: ~2-5MB（取决于币种数量）
- **每天4次**: ~10-20MB
- **建议**: WiFi环境下使用

---

## 🎨 用户体验提升

### 操作步骤减少
**之前**:
```
收到通知 → 解锁手机 → 打开应用 → 点击"结果"标签 → 查看结果
（5步）
```

**现在**:
```
收到通知 → 点击通知 → 查看结果
（2步，减少60%）
```

### 信息获取效率
- **时间信息**: 通知中直接显示，无需进入应用
- **结果预览**: 显示前3名币种，快速了解市场
- **智能过滤**: 无结果时不打扰，重要变化及时提醒

### 后台稳定性
- **WakeLock**: 确保定时任务不被中断
- **前台服务**: 防止系统杀死进程
- **持久通知**: 用户可见服务状态

---

## ⚠️ 注意事项

### 1. 手机厂商限制
部分手机厂商（小米、华为、OPPO、Vivo）有严格的后台限制，需要手动设置：

**小米**:
```
设置 → 应用设置 → 应用管理 → 币安分析工具 
→ 省电策略 → 无限制
→ 自启动管理 → 允许
```

**华为**:
```
设置 → 电池 → 应用启动管理 → 币安分析工具 
→ 手动管理 → 允许后台活动
```

**OPPO/Vivo**:
```
设置 → 电池 → 高耗电应用 → 币安分析工具 
→ 允许后台运行
```

### 2. 省电模式
系统省电模式可能限制后台运行，建议：
- 将应用加入白名单
- 充电时使用
- 关闭省电模式

### 3. 前台服务通知
- 持久通知无法删除（设计如此）
- 优先级为LOW，不会打扰用户
- 如需隐藏，关闭定时任务并重启应用

### 4. 电量管理
- 定时间隔建议2-4小时
- 减少"最大分析数量"可降低电量消耗
- 夜间可适当延长间隔

---

## 🧪 测试清单

### 功能测试
- [ ] 通知显示时间（HH:MM:SS格式）
- [ ] 点击通知跳转到结果页面
- [ ] 后台运行（Home键后台）
- [ ] 锁屏运行（电源键锁屏）
- [ ] 前台服务通知显示
- [ ] 匹配数量为0时不通知
- [ ] 从有变无时发送清零通知

### 性能测试
- [ ] 电量消耗（2小时间隔）
- [ ] 内存占用（长时间运行）
- [ ] 网络流量（单次分析）
- [ ] 后台稳定性（24小时测试）

### 兼容性测试
- [ ] Android 5.0 (API 21)
- [ ] Android 8.0 (API 26) - 通知渠道
- [ ] Android 12 (API 31) - PendingIntent
- [ ] Android 13 (API 33) - 通知权限

---

## 🚀 未来规划

### 短期（v1.3.0）
- [ ] 通知操作按钮（快速停止/重新分析）
- [ ] 自定义通知跳转目标
- [ ] 通知历史记录

### 中期（v1.4.0）
- [ ] JobScheduler替代Thread（更省电）
- [ ] 智能省电模式（电量低时自动调整）
- [ ] 网络状态检测（WiFi/移动数据）

### 长期（v2.0.0）
- [ ] 多交易所支持（OKX、Bybit）
- [ ] 自定义筛选条件（技术指标）
- [ ] 图表展示（K线图、趋势图）

---

## 📝 更新建议

### 对于新用户
1. 安装最新版本（v1.2.0）
2. 授予所有权限
3. 关闭手机的电池优化
4. 设置定时间隔为2-4小时
5. 开启Server酱推送（可选）

### 对于老用户
1. 卸载旧版本
2. 安装新版本
3. 重新配置参数
4. 测试后台运行和通知功能

---

**版本**: v1.2.0  
**发布日期**: 2025-12-19  
**兼容性**: Android 5.0+ (API 21+)
